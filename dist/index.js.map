{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["\nconst BATCH_SIZE = 2;\n\nexport enum BeesLoadStatus {\n  Loading = \"loading\",\n  Failed = \"failed\",\n  Completed = \"completed\",\n}\n\nexport interface BeesLoadData {\n  type: \"SUCCESS\" | \"ERROR\";\n  status?: number;\n  data?: string;\n  stringToCompare?: string | undefined;\n  id: string;\n}\n\nexport interface BeesLoadCompleted {\n  [id: string]: {\n    ids: string[];\n    data: string;\n    stringToCompare: string | undefined;\n  };\n}\n\nexport interface BeesLoadErrors {\n  [id: string]: {\n    id: string;\n    status?: number;\n  };\n}\n\nexport enum BeesLoadError {\n  InsufficientNumberOfNodes = \"Insufficient number of nodes\",\n  OutOfNodes = \"Out of nodes\",\n  UnstableState = \"Unstable state\",\n  UnaccurateState = \"Unaccurate state\",\n}\n\nexport interface BeesLoadErrorWithArgs {\n  error: BeesLoadError;\n  args: { [key: string]: any };\n}\n\nexport interface ResolverOutput {\n  loadState: BeesLoadCompleted;\n  loadErrors: BeesLoadErrors;\n  loadPending: string[];\n  loadError?: BeesLoadErrorWithArgs;\n  status: BeesLoadStatus;\n}\n\nconst indexData = (\n  data: BeesLoadData,\n  existingData: BeesLoadCompleted,\n  comparer?: (x: string | undefined) => any\n): BeesLoadCompleted => {\n  let found = false;\n  let stringToCompare = data.data;\n\n  if (typeof comparer === \"function\") {\n    try {\n      stringToCompare = comparer(data.data);\n    } catch (err) {\n      throw err;\n    }\n  }\n\n  // initialize existingData\n  if (Object.keys(existingData).length === 0) {\n    existingData = {\n      \"1\": {\n        ids: [data.id],\n        data: data.data || \"\",\n        stringToCompare: stringToCompare,\n      },\n    };\n  } else {\n    Object.keys(existingData).forEach((key) => {\n      if (stringToCompare === existingData[key].stringToCompare) {\n        found = true;\n        existingData = {\n          ...existingData,\n          [key]: {\n            ...existingData[key],\n            ids: existingData[key].ids.concat(data.id),\n          },\n        };\n      }\n    });\n  \n    if (!found) {\n      existingData = {\n        ...existingData,\n        [Object.keys(existingData).length + 1]: {\n          ids: [data.id],\n          data: data.data,\n          stringToCompare: stringToCompare,\n        },\n      };\n    }\n  }\n\n  return existingData;\n};\n\nexport const resolver = (\n  queryHandler: (urlToQuery: string) => Promise<BeesLoadData>,\n  ids: string[],\n  resolverAccuracy: number,\n  resolverAbsolute: number,\n  comparer?: (x: string | undefined) => any\n): Promise<ResolverOutput> => {\n  let loadErrors: BeesLoadErrors = {};\n  let loadState: BeesLoadCompleted = {};\n  let loadPending: string[] = [];\n\n  return new Promise((resolve, reject) => {\n    if (resolverAbsolute > ids.length) {\n      resolve({\n        loadErrors: loadErrors,\n        loadState: loadState,\n        loadPending: loadPending,\n        loadError: {\n          error: BeesLoadError.InsufficientNumberOfNodes,\n          args: {\n            expected: resolverAbsolute,\n            got: ids.length,\n          },\n        },\n        status: BeesLoadStatus.Failed,\n      });\n      return;\n    }\n\n    let i = 0;\n\n    const callBatch = async (i: number) => {\n      console.log('callBatch', i);\n      // idsToQuery is of same size as resolverAbsolute\n      // but you can change this to do 3 by 3 or 4 by 4 etc.\n      const idsToQuery = ids.slice(i, i + BATCH_SIZE);\n\n      if (idsToQuery.length === 0) {\n        resolve({\n          loadErrors: loadErrors,\n          loadState: loadState,\n          loadPending: loadPending,\n          loadError: {\n            error: BeesLoadError.OutOfNodes,\n            args: {\n              alreadyQueried: i - Object.keys(loadErrors).length,\n              resolverAbsolute: resolverAbsolute,\n            },\n          },\n          status: BeesLoadStatus.Failed,\n        });\n        return;\n      }\n\n      i += idsToQuery.length;\n\n      loadPending = loadPending.concat(idsToQuery);\n\n      const responses = await Promise.all(idsToQuery.map(id => queryHandler(id)));\n\n      responses.forEach((data: BeesLoadData) => {\n        loadPending = loadPending.filter((id) => id !== data.id);\n\n        if (data.type === \"SUCCESS\") {\n          try {\n            loadState = indexData(data, loadState, comparer);\n          } catch (err) {\n            loadErrors = {\n              ...loadErrors,\n              [data.id]: {\n                id: data.id,\n                status: (err as any).message ? parseInt((err as any).message, 10) : 400,\n              },\n            };\n          }\n        } else {\n          loadErrors = {\n            ...loadErrors,\n            [data.id]: {\n              id: data.id,\n              status: data.status,\n            },\n          };\n        }\n\n      });\n\n      if (Object.keys(loadState).length > 2) {\n        resolve({\n          loadErrors: loadErrors,\n          loadState: loadState,\n          loadPending: loadPending,\n          loadError: {\n            error: BeesLoadError.UnstableState,\n            args: {\n              numberOfLoadStates: Object.keys(loadState).length,\n            },\n          },\n          status: BeesLoadStatus.Failed,\n        });\n        return;\n      } else {\n        const totalOkResponses = Object.keys(loadState).reduce(\n          (total, k) => {\n            return total + loadState[k].ids.length;\n          },\n          0\n        );\n\n        // don't ruen this into a .forEach, return are\n        // not effecive in forEach loops\n        for (let j = 0; j < Object.keys(loadState).length; j += 1) {\n          const key = Object.keys(loadState)[j];\n\n          const nodesWithOkResponses = loadState[key].ids.length;\n\n          // at least [resolverAbsolute] responses of the same\n          // resolver must Complete or Fail\n          if (nodesWithOkResponses >= resolverAbsolute) {\n            if (\n              resolverAccuracy / 100 >\n              loadState[key].ids.length / totalOkResponses\n            ) {\n              resolve({\n                loadErrors: loadErrors,\n                loadState: loadState,\n                loadPending: loadPending,\n                loadError: {\n                  error: BeesLoadError.UnaccurateState,\n                  args: {\n                    totalOkResponses: totalOkResponses,\n                    loadStates: Object.keys(loadState).map((k) => {\n                      return {\n                        key: k,\n                        okResponses: loadState[k].ids.length,\n                        percent:\n                          Math.round(\n                            (100 *\n                              (100 * loadState[k].ids.length)) /\n                              totalOkResponses\n                          ) / 100,\n                      };\n                    }),\n                  },\n                },\n                status: BeesLoadStatus.Failed,\n              });\n              // will stop for loop\n              return;\n            }\n\n            resolve({\n              loadErrors: loadErrors,\n              loadState: loadState,\n              loadPending: loadPending,\n              status: BeesLoadStatus.Completed,\n            });\n            // will stop for loop\n            return;\n          }\n        }\n      }\n\n      // if no return in for loop, go\n      // on next batch\n      callBatch(i);\n    };\n\n    callBatch(i);\n  });\n};\n"],"names":["BeesLoadStatus","BeesLoadError"],"mappings":"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"}